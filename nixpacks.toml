# Nixpacks Configuration for SoftwarePros
# Optimized for security and performance

[phases.setup]
nixPkgs = ["nodejs-18_x", "npm-9_x", "openssl", "curl", "bash"]

[phases.install]
cmds = [
    "npm ci --production=false",
    "npm run build"
]

[phases.start]
cmd = "npm start"

[variables]
NODE_ENV = "production"
NPM_CONFIG_PRODUCTION = "false"

# Security headers for production
[phases.start.env]
PORT = "3000"
HOSTNAME = "0.0.0.0"

# Environment variables that should be set in Coolify
# NEXTAUTH_URL = "https://yourdomain.com"
# NEXTAUTH_SECRET = "your-secret-key"
# DATABASE_URL = "your-database-url"
# REDIS_URL = "your-redis-url"

[build]
builder = "NIXPACKS"

# Build optimization
[build.optimization]
minify = true
compress = true

# Security settings
[security]
allowInsecure = false
requireSSL = true

# Health check
[healthcheck]
endpoint = "/api/health"
timeout = 30
retries = 3

# Static file configuration
[static]
directory = ".next/static"
headers = { "Cache-Control" = "public, max-age=31536000, immutable" }

# Environment-specific configurations
[environments.production]
variables.NODE_ENV = "production"
variables.NPM_CONFIG_PRODUCTION = "true"

[environments.staging]
variables.NODE_ENV = "staging"
variables.NPM_CONFIG_PRODUCTION = "false"

[environments.development]
variables.NODE_ENV = "development"
variables.NPM_CONFIG_PRODUCTION = "false"